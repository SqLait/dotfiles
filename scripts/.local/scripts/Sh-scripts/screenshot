#!/usr/bin/env bash

# Current Theme
theme='menu/grim'

# Options
entire_screen="Entire screen"
select_area="Select an area"

copy="Copy to clipboard"
save="Save file"

# Temporary filename path to store in ~/Pictures
tmp_filename="$HOME/Pictures/screenshot_$(date +%d)-$(date +%m)-$(date +%y)_$(date +%T).png"

# Rofi CMD
rofi_cmd() {
	rofi -dmenu \
		-mesg "Screenshot" \
		-theme ${theme}.rasi
}

# Pass variables to rofi dmenu
run_rofi() {
	echo -e "$entire_screen\n$select_area" | rofi_cmd
}

# Mode selection
mode_cmd() {
	rofi -theme-str 'window {location: center; anchor: center; fullscreen: false; width: 250px;}' \
		-theme-str 'mainbox {children: [ "message", "listview" ];}' \
		-theme-str 'listview {columns: 1; lines: 2;}' \
		-theme-str 'element-text {horizontal-align: 0.5;}' \
		-theme-str 'textbox {horizontal-align: 0.5;}' \
		-dmenu \
		-mesg 'Screenshot taken' \
		-theme ${theme}.rasi
}

# Ask to select mode
select_mode() {
	echo -e "$copy\n$save" | mode_cmd
}

menu_option="$(run_rofi)"
if [[ ! -z "$menu_option" ]]; then
	case $menu_option in 
		$entire_screen)
			# Delay to ensure the Rofi menu disappears
			sleep 1
			# Capture the entire screen
			grim $tmp_filename
			;;
		$select_area)
			# Select an area to capture
			grim -g "$(slurp)" $tmp_filename
			;;
	esac

	# Ask user whether to copy to clipboard or save the file
	mode="$(select_mode)"
	if [[ ! -z "$mode" ]]; then
		case $mode in
			$copy)
				wl-copy --type image/png < $tmp_filename
				;;
			$save)
				# The screenshot is already saved in ~/Pictures, so no need to move it
				;;
		esac
	fi
fi

